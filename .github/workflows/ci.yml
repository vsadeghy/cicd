name: check and build
on:
    push:
        branches: [main, dev]
    pull_request:
        branches: [main, dev]

jobs:
    checks:
        runs-on: ubuntu-slim
        steps:
            - name: checkout
              uses: actions/checkout@v6
            - name: install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.16.1
            - name: setup node
              uses: actions/setup-node@v6
              with:
                  node-version: 25
                  cache: pnpm

            - name: install deps
              run: pnpm install --frozen-lockfile --ignore-scripts
            - name: lint
              run: pnpm lint --max-warnings 0
            - name: format
              run: pnpm format:check
            - name: types
              run: pnpm typecheck
            - name: test
              run: pnpm test

    build:
        needs: checks
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
            - name: login to ghcr
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Build and push
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: |
                      ghcr.io/${{ github.repository }}:latest
                      ghcr.io/${{ github.repository }}:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
